FROM openresty/openresty:alpine-fat

ENV AUTO_SSL_VERSION='0.11.1'

RUN apk --no-cache add bash openssl \
    && /usr/local/openresty/luajit/bin/luarocks install lua-resty-auto-ssl $AUTO_SSL_VERSION \
    # Remove nginx default config
    && rm /etc/nginx/conf.d/default.conf

COPY ./deployment/dockerfiles/snippets/nginx-issuer/nginx.conf.template /usr/local/openresty/nginx/conf/
COPY ./deployment/dockerfiles/snippets/nginx-issuer/dehydrated.conf /data/resty-auto-ssl/letsencrypt/conf.d

COPY ./deployment/dockerfiles/scripts/nginx-issuer/entrypoint.sh /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]

CMD ["/usr/local/openresty/bin/openresty", "-g", "daemon off;"]
