# --- Origin.js

FROM node:9 as origin-js-build

COPY ./origin-js /app
WORKDIR /app

ENV NODE_ENV production
RUN npm install --quiet --no-progress
RUN npm run build

# --- DApp

FROM node:9 as build

ARG DEPLOY_TAG

COPY ./origin-dapp /app
WORKDIR /app/

ENV BRIDGE_SERVER_DOMAIN=bridge.staging.originprotocol.com \
    BRIDGE_SERVER_PROTOCOL=https \
    DISCOVERY_SERVER_URL=https://discovery.staging.originprotocol.com \
    ETH_NETWORK_ID=4 \
    IPFS_DOMAIN=ipfs.staging.originprotocol.com \
    IPFS_GATEWAY_PORT=443 \
    IPFS_GATEWAY_PROTOCOL=https \
    IPFS_API_PORT=443 \
    IPFS_SWARM=/dnsaddr/messaging.staging.originprotocol.com/tcp/443/wss/ipfs/QmR4xhzHSKJiHmhCTf3tWXLe3UV4RL5kqUJ2L81cV4RFbb \
    ARBITRATOR_ACCOUNT=0xc9c1a92ba54c61045ebf566b154dfd6afedea992 \
    AFFILIATE_ACCOUNT=0xc1a33cda27c68e47e370ff31cdad7d6522ea93d5 \
    MESSAGING_ACCOUNT=0xA9F10E485DD35d38F962BF2A3CB7D6b58585D591 \
    PROVIDER_URL=https://rinkeby.infura.io/emIXjs9eDuy57IlTYsIP \
    MESSAGING_NAMESPACE=origin:staging \
    DEPLOY_TAG=$DEPLOY_TAG \
    BLOCK_EPOCH=3050000 \
    INSTRUCTIONS_URL=https://medium.com/originprotocol/draft-origin-launches-beta-on-mainnet-draft-e3b70161ae86

ENV NODE_ENV production
WORKDIR /app
# Link previously built Origin.js
COPY --from=origin-js-build /app/origin-js/ /usr/local/lib/node_modules/origin
RUN npm link origin
# Build DApp
RUN npm install --quiet --no-progress
RUN node_modules/.bin/webpack --display errors-only

# Copy static files to nginx for serving
FROM nginx:1.15.2-alpine
COPY --from=build /app/build /usr/share/nginx/html
CMD ["nginx", "-g", "daemon off;"]
