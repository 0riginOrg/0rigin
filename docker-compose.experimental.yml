version: "3"

services:
  postgres:
    container_name: postgres
    restart: always
    image: postgres:10.0
    environment:
      - POSTGRES_USER=origin
      - POSTGRES_PASSWORD=origin
      - POSTGRES_DB=origin

  elasticsearch:
    container_name: elasticsearch
    image: elasticsearch
    build:
      context: .
      dockerfile: development/dockerfiles/elasticsearch
    ports:
      - "9200:9200"
    environment:
      network.bind_host: 0
      ES_JAVA_OPTS: "-Xmx256m -Xms256m"
    logging:
      driver: none

  origin-dapp2:
    container_name: origin-dapp2
    image: origin-experimental
    build:
      context: .
      dockerfile: Dockerfile-experimental
    volumes:
      # Include origin-contracts build files so the DApp has access to the
      # address of the contracts on the local blockchain
      - ./origin-contracts/build:/app/origin-contracts/build
      - ./experimental:/app/experimental
    ports:
      - "8083:8083"
      - "3001:3001"
    environment:
      - DOCKER=true
    command: npm run start --prefix experimental/origin-dapp2

  origin-ipfs-proxy:
    container_name: origin-ipfs-proxy
    image: origin-experimental
    ports:
      - "9999:9999"
    environment:
      - IPFS_API_URL=http://origin-admin:5002
      - IPFS_GATEWAY_URL=http://origin-admin:9090
    volumes:
      - ./origin-ipfs-proxy/src:/app/origin-ipfs-proxy/src
      - ./origin-ipfs-proxy/package.json:/app/origin-ipfs-proxy/package.json
    command: npm run start --prefix origin-ipfs-proxy

  origin-discovery:
    container_name: origin-discovery
    image: origin-experimental
    volumes:
      - ./origin-js/src:/app/origin-js/src
      - ./origin-discovery/src:/app/origin-discovery/src
      - ./origin-discovery/config:/app/origin-discovery/config
      - ./origin-discovery/package.json:/app/origin-discovery/package.json
    environment:
      - DATABASE_URL=postgres://origin:origin@postgres/origin
      - ELASTICSEARCH_HOST=elasticsearch:9200
    depends_on:
      - postgres
      - elasticsearch
    ports:
      - "4000:4000"
    command: npm run start:discovery --prefix origin-discovery

