defaults: &defaults
  docker:
    - image: circleci/node:10-browsers
    - image: circleci/postgres:9.6-alpine-ram
      environment:
        POSTGRES_USER: postgres
        POSTGRES_DB: travis_ci_test
  working_directory: ~/origin

version: 2
jobs:
  setup_environment:
    <<: *defaults
    steps:
      - run: |
          git clone --depth=1 -b $CIRCLE_BRANCH https://github.com/OriginProtocol/origin.git ~/origin
      - restore_cache:
          key: yarn-packages-v3-{{ checksum "yarn.lock" }}
      - run: |
          yarn install --frozen-lockfile
          curl -sfL https://install.goreleaser.com/github.com/tj/node-prune.sh | sh
          ./bin/node-prune
      - save_cache:
          key: yarn-packages-v3-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - persist_to_workspace:
          root: .
          paths:
            - .

  "javascript linting":
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run: npm run lint

  "@origin/marketplace integration tests":
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run: npm run test --prefix dapps/marketplace

  test_graphql:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run: npm run test --prefix packages/graphql

  test_event_cache:
    <<: *defaults
    environment:
      DATABASE_URL: postgres://postgres@localhost/travis_ci_test
    steps:
      - attach_workspace:
          at: .
      - run: ./node_modules/.bin/lerna run migrate --scope @origin/event-cache
      - run: npm run test --prefix packages/event-cache

  test_bridge:
    <<: *defaults
    environment:
      DATABASE_URL: postgres://postgres@localhost/travis_ci_test
    steps:
      - attach_workspace:
          at: .
      - run: ./node_modules/.bin/lerna run migrate --scope @origin/bridge
      - run: npm run test --prefix infra/bridge

  test_contracts:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run: npm run test --prefix packages/contracts

  test_discovery:
    <<: *defaults
    environment:
      DATABASE_URL: postgres://postgres@localhost/travis_ci_test
      AFFILIATE_ACCOUNT: 0x821aea9a577a9b44299b9c15c88cf3087f3b5544
      ARBITRATOR_ACCOUNT: 0x0d1d4e623d10f9fba5db95830f7d3839406c6af2
      ATTESTATION_ACCOUNT: 0x99C03fBb0C995ff1160133A8bd210D0E77bCD101
    steps:
      - attach_workspace:
          at: .
      - run: |
          ./node_modules/.bin/lerna run migrate --scope @origin/bridge
          ./node_modules/.bin/lerna run migrate --scope @origin/discovery
          ./node_modules/.bin/lerna run migrate --scope @origin/growth
          ./node_modules/.bin/lerna run migrate --scope @origin/identity
          npm run test --prefix infra/bridge

  test_growth:
    <<: *defaults
    environment:
      DATABASE_URL: postgres://postgres@localhost/travis_ci_test
    steps:
      - attach_workspace:
          at: .
      - run: |
          ./node_modules/.bin/lerna run migrate --scope @origin/growth
          ./node_modules/.bin/lerna run migrate --scope @origin/identity
          npm run test --prefix infra/growth

  test_notifications:
    <<: *defaults
    environment:
      DATABASE_URL: postgres://postgres@localhost/travis_ci_test
    steps:
      - attach_workspace:
          at: .
      - run: |
          ./node_modules/.bin/lerna run migrate --scope @origin/notifications
          npm run test --prefix infra/notifications

workflows:
  version: 2
  test:
    jobs:
      - setup_environment
      - "javascript linting":
          requires:
            - setup_environment
      - "@origin/marketplace integration tests":
          requires:
            - setup_environment
      - test_graphql:
          requires:
            - setup_environment
      - test_event_cache:
          requires:
            - setup_environment
      - test_bridge:
          requires:
            - setup_environment
      - test_contracts:
          requires:
            - setup_environment
      - test_discovery:
          requires:
            - setup_environment
      - test_growth:
          requires:
            - setup_environment
      - test_notifications:
          requires:
            - setup_environment
