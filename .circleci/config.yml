defaults: &defaults
  docker:
    - image: circleci/node:10-browsers
  working_directory: ~/origin

db: &db
  docker:
    - image: circleci/node:10-browsers
    - image: circleci/postgres:9.6-alpine-ram
      environment:
        POSTGRES_USER: postgres
        POSTGRES_DB: circle_ci_test
  working_directory: ~/origin
  environment:
    DATABASE_URL: postgres://postgres@localhost/circle_ci_test

version: 2
jobs:
  Setup:
    <<: *defaults
    steps:
      - run:
          name: Clone Repo
          command: |
            git clone --depth=1 -b $CIRCLE_BRANCH https://github.com/OriginProtocol/origin.git ~/origin
      - restore_cache:
          key: yarn-packages-v5-{{ checksum "yarn.lock" }}
      - run:
          name: Yarn Install
          command: |
            yarn policies set-version
            yarn install --frozen-lockfile
            curl -sfL https://install.goreleaser.com/github.com/tj/node-prune.sh | sh
            ./bin/node-prune
      - save_cache:
          key: yarn-packages-v5-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - persist_to_workspace:
          root: .
          paths:
            - .

  Lint:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run: yarn lint

  Marketplace:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run: ./node_modules/.bin/lerna run test --scope @origin/marketplace

  GraphQL:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run: ./node_modules/.bin/lerna run test --scope @origin/graphql

  EventCache:
    <<: *db
    steps:
      - attach_workspace:
          at: .
      - run: ./node_modules/.bin/lerna run migrate --scope @origin/event-cache
      - run: ./node_modules/.bin/lerna run test --scope @origin/event-cache

  Bridge:
    <<: *db
    steps:
      - attach_workspace:
          at: .
      - run: ./node_modules/.bin/lerna run migrate --scope @origin/bridge
      - run: ./node_modules/.bin/lerna run test --scope @origin/bridge

  Contracts:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run: ./node_modules/.bin/lerna run test --scope @origin/contracts

  Discovery:
    <<: *db
    steps:
      - attach_workspace:
          at: .
      - run: |
          ./node_modules/.bin/lerna run migrate --scope @origin/bridge
          ./node_modules/.bin/lerna run migrate --scope @origin/discovery
          ./node_modules/.bin/lerna run migrate --scope @origin/growth
          ./node_modules/.bin/lerna run migrate --scope @origin/identity
          ./node_modules/.bin/lerna run test --scope @origin/bridge

  Growth:
    <<: *db
    steps:
      - attach_workspace:
          at: .
      - run: |
          ./node_modules/.bin/lerna run migrate --scope @origin/growth
          ./node_modules/.bin/lerna run migrate --scope @origin/identity
          ./node_modules/.bin/lerna run test --scope @origin/growth

  Notifications:
    <<: *db
    steps:
      - attach_workspace:
          at: .
      - run: |
          ./node_modules/.bin/lerna run migrate --scope @origin/notifications
          ./node_modules/.bin/lerna run test --scope @origin/notifications

workflows:
  version: 2
  test:
    jobs:
      - Setup
      - Lint:
          requires:
            - Setup
      - Marketplace:
          requires:
            - Setup
      - GraphQL:
          requires:
            - Setup
      - EventCache:
          requires:
            - Setup
      - Bridge:
          requires:
            - Setup
      - Contracts:
          requires:
            - Setup
      - Discovery:
          requires:
            - Setup
      - Growth:
          requires:
            - Setup
      - Notifications:
          requires:
            - Setup
