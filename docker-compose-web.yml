version: "3"

networks:
  origin-website-develop:

volumes:
  pg_data:

services:
  postgres:
    container_name: postgres
    restart: always
    image: postgres:10.0
    # Data persistence, comment out the following two lines to disable
    volumes:
      - pg_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=origin
      - POSTGRES_PASSWORD=origin
      - POSTGRES_DB=origin_website
    networks:
      - origin-website-develop

  redis:
    container_name: redis
    restart: always
    image: redis
    sysctls:
      - net.core.somaxconn=4096
    networks:
      - origin-website-develop

  origin-website:
    container_name: origin-website
    build:
      context: .
      dockerfile: dockerfiles/origin-website
    image: origin-website
    volumes:
      - ./origin-website:/app
      # Set the envfile from the local envfile
      - ./envfiles/origin-website.env:/app/.env
    depends_on:
      - postgres
      - redis
    ports:
      - "5000:5000"
    environment:
      - FLASK_APP=/app/main.py
    command: "python /app/main.py"
    networks:
      - origin-website-develop

  origin-website-celery:
    container_name: origin-website-celery
    image: origin-website
    user: nobody
    depends_on:
      - postgres
      - redis
    volumes:
      - ./origin-website:/app
      # Set the envfile from the local envfile
      - ./envfiles/origin-website.env:/app/.env
    environment:
      # TODO this should be read from the .env file in origin-website
      - CELERY_DEBUG=False
      # TODO same as above
      - REDIS_URL=redis://redis:6379/1
      - FLASK_APP=/app/main.py
    command: "watchmedo auto-restart -d . -p '*.py' -i '*.pyc' --recursive --
      celery -A util.tasks worker --loglevel=INFO"
    networks:
      - origin-website-develop
